### 使用 BigQuery ML 构建电子商务推荐系统

### 使用 BigQuery ML 构建图片识别系统


## 1. 使用 BigQuery ML 构建电子商务推荐系统

XX电商平台项目包括用户管理，商家管理，物流跟踪，用户推荐系统等模块，我主要负责其中的用户推荐模块


### 1.1 Situation（发生了什么情况）

为了针对用户个性化推荐商品，提高用户对推荐商品的购买率，需要分析用户对商品购买意愿，刻画用户画像，推荐相似画像的用户特定商品提高购买率。
流程如下：
- 1.提取用户基本信息，提取用户对商品的浏览持续时长并划分等级
- 2.模型选择，模型预测，部署
- 3.整合到源项目


### 1.2 Task（任务是什么？）--难点

- 需要提取何种信息进行模型训练？如何提取信息？
- 如何刻画用户画像？
- 整合项目到生产环境中    --可作为商城推荐下的一个子模块


### 1.3 Action（提出了什么方案，如何解决）

- 1.针对用户对商品的购买意愿分析
- - 从数据库或消息队列取出数据--清洗取出关键信息 userid，itemid，session_duration
- - session_duration可以抽象成用户购买意愿等级作为划分依据
- - 创建矩阵分解模型(Create Model) 将模型部署到生产环境
- 2.描绘用户画像&&推荐预热
- - 用户基本信息表和交易表区分不同年龄段，地区用户的购买意愿级别，提取出top20做同地区/同年龄段 预热推荐
- - 根据用户选择，可推荐数据库中预测购买意愿等级高的同类产品


### 1.4 Result（结果如何？）
- 数据仓库选择BigQuery ML，训练模型利用数据仓库中create model进行
- 成功解决以上问题


## 2. 使用 Flask,TensorFlow 构建图片识别系统


包括口罩识别提示模块，垃圾分类模块


### 1.1 Situation（发生了什么情况）

为了提醒大家疫情期间进入公共场所积极佩戴口罩，加强垃圾分类相关知识，推出了有红外测温功能的口罩检测系统，同时该系统支持用户上传图片进行垃圾分类辅助检测



### 1.2 Task（任务是什么？）--难点

- 口罩检测系统？如何提取信息？
- 记录数据库员工考勤信息
- 整合多类型检测


### 1.3 Action（提出了什么方案，如何解决）

- 1.不同提示功能，体温超过阈值，未佩戴口罩
- 2.考虑到检测仪性能，需要模型尽可能轻巧
- 3.个性化需求，引入垃圾分类检测接口（网站）



### 1.4 Result（结果如何？）
- 人脸识别率98
- 人脸口罩识别95




## 2. 自动导航系统


自动导航系统中障碍物感知系统模型搭建，KPI统计


### 1.1 Situation（发生了什么情况）

自动导航系统中需要实现对障碍物的感知（距离，障碍物类型）以及衡量障碍物感知系统的工作的准确率
- 1. 当摄像头拍摄范围内有行人，车辆出现时可以正确识别，生成3D检测框，距离本车车头最近距离，以及碰撞时间
- 2. 根据后台反馈的信号信息统计感知系统的准确率



### 1.2 Task（任务是什么？）--难点

- 如何对数据进行统一处理，两种不同格式数据如何对应
- 对行人和车辆作出区分，以便计算中心点，碰撞时间
- 在不同场景下障碍物感知系统不同于实验环境，如何根据信号值信息统计KPI


### 1.3 Action（提出了什么方案，如何解决）

- 1. 提出基于3D处理模型+2D特征值提取的模型作为感知算法
- - 2D图片不含有深度信息无法准确定位
- - 3D点云数据不含有颜色信息且3D逐点检测处理信息量大
- 2. 对人，车的检测框预处理设置不同大小，同时设置不同阈值
- - 行人检测信息点少，更依赖图像信息，则2D特征提取权重更高
- - 车辆检测 点云数据提供更充分并且误报少，所以车辆检测2D特处理流权重更高
- 3. 源信号和经过系统处理后的信号进行对照并匹配目标物
- - 通过对系统输出信号值清洗，选出计算KPI相关信号值
- - 通过不同方法计算KPI，距离，IOU
- - 逐帧匹配目标物时抽象成矩阵进行处理


### 1.4 Result（结果如何？）
- 多模态检测比纯3D检测快 5fp--16fp
- 准确率2D 76 ---81.04 -----
- KPI统计准确率79

## 3.使用Dataflow和Video Intelligence API 构建对象追踪视频分析流水线

### 3.1 Situation 发生了什么

  监控公司可以通过实时视频分析系统分析摄像机拍摄的监控视频画面，并按照所设定的报警条件，自动的分析出当前的监控位置的警情，自动发出报警。大大提高了用人眼监控的工作效率，使得报警更加及时，能对成千上百路视频同时分析，监测更加全面，也大大降低安保人员的工作量，提高监控效率，降低运营费用。

  使用场景：安全帽识别；烟火识别；周界入侵；人脸识别；客流统计

### 3.2 Task是什么 -- 难点

- 如何构建流水线，低延迟又能满足所有功能
- 整个项目概括为：视频信息提取，处理，存储，操作
- 场景，高并发场景，可以多线程多进程操作，有秩序操作
- 在连续的几个视频段进行对象追踪，是否连续，大于阈值则认为是元对象，否则记录为新对象
- 因为需要持续输入数据，因此pubsub为持续工作的流水线，当有数据输入时将数据保存到云存储区，并通过Pub/Sub通知Dataflow

### 3.3 Action 提出了什么方案，如何解决

![uild-streamin](img\build-streaming.png)

​	视频数据被拆分成5s的视频片段（可设定）上传到cloud storage（google cloud提供的一个云存储空间，并对其创建pub/sub topic），对于每项文件上传操作，通过建立DataFlow分配虚拟机执行数据，大致的流程是我们需要在DataFlow中用Pub/Sub进行连接四个模块，分别为1.cloudstoage存储模块，用来对实时视频进行存储并切分为2s的片段等待处理。2.流处理模块，调用cloud intelligence API对视频进行分析（包含数据，timeoffset,entity,file_name,confidence置信度，box，每隔2s抽一帧），得到分析的数据筛选（每隔2s筛选出未佩戴安全帽的工人,）存储模块，将API处理得到的数据结果结果保存在BigQuery中等待分析，响应模块，对处理得到的信息进行响应（3次违规，警告未佩戴安全帽的工人）。

流程

- 客户端将原视频文件上传到Cloud Storage 存储分区
- 对于每项文件上传操作，系统会通过向Pub/Sub发布消息自动通知客户端
- 对于每条信息，Dataflow会执行以下操作
- 从Pub/Sub中读取文件元数据
- 将文件加载到内存，将文件加载到内存，并将其拆分为数个5秒的片段
- 将每个片段发送到intelligence API，后者会返回注释
- 将所有注释信息存储在BigQuerry中
- 对于包含流水线的可自定义的参数指定的有意义注释的视频代码（需要监测预警的数据段），将输出消息发送到Pub/Sub
- 消费者应用从Pub/Sub读取消息

### 3.4 Result 结果如何

工作数据量，准确率实现24小时无人监测